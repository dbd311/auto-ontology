name: Ontology CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  ontology-validation:
    runs-on: ubuntu-latest
    container: 
      image: stain/jena
      options: --user root

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        apk update
        apk add --no-cache bash python3 py3-pip openjdk17-jre wget
        wget https://github.com/ontodev/robot/releases/latest/download/robot.jar -O /usr/local/bin/robot.jar
        echo '#!/bin/sh\njava -jar /usr/local/bin/robot.jar "$@"' > /usr/local/bin/robot
        chmod +x /usr/local/bin/robot

    - name: Merge ontology
      run: |
        chmod +x scripts/merge_ontology.sh
        ./scripts/merge_ontology.sh . automobile_merged.ttl

    - name: Basic RDF validation
      run: riot --validate automobile_merged.ttl

    - name: Create reports directory
      run: mkdir -p validation-reports

    - name: Run ROBOT validation
      continue-on-error: true
      run: |
        robot report --input automobile_merged.ttl --output validation-reports/report.json
        robot verify --input automobile_merged.ttl \
          --queries sparql/validation_queries/*.rq \
          --output-dir validation-reports/
        echo "Validation completed with $(grep -c "level.: \"ERROR\"" validation-reports/report.json || echo 0) errors"

    - name: Verify reports exist
      run: |
        echo "Validation reports:"
        ls -la validation-reports/
        [ -f validation-reports/report.json ] || { echo "No report.json found"; exit 1; }

    - name: Upload validation reports
      uses: actions/upload-artifact@v4
      with:
        name: validation-reports
        path: |
          automobile_merged.ttl
          validation-reports/*
        retention-days: 7

    - name: Check validation results
      if: ${{ failure() && steps.robot_validation.outcome == 'failure' }}
      run: |
        errors=$(grep -c "level.: \"ERROR\"" validation-reports/report.json || echo 0)
        if [ "$errors" -gt 0 ]; then
          echo "::error::Found $errors validation errors"
          exit 1
        fi