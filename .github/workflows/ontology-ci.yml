name: Ontology CI/CD Pipeline

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

jobs:
  ontology-validation:
    runs-on: ubuntu-latest
    container: 
      image: stain/jena
      options: --user root

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python (for ROBOT)
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y python3-pip
        pip install robotframework
        pip install rdflib

    - name: Make scripts executable
      run: |
        chmod +x scripts/merge_ontology.sh
        chmod +x scripts/validate_sparql.sh

    - name: Merge ontology
      run: |
        ./scripts/merge_ontology.sh auto-ontology automobile_merged.ttl
        ls -lh

    - name: Basic RDF validation
      run: riot --validate automobile_merged.ttl

    - name: OWL validation with ROBOT
      run: |
        robot validate --input automobile_merged.ttl \
          --output-dir ./validation-reports \
          --profile owl-el

    - name: SPARQL validation
      run: |
        ./scripts/validate_sparql.sh automobile_merged.ttl sparql/validation_queries/

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ontology-artifacts
        path: |
          automobile_merged.ttl
          validation-reports/*
          sparql_results/*

    - name: Upload Widoco documentation
      if: success()
      uses: actions/upload-pages-artifact@v1
      with:
        path: docs/