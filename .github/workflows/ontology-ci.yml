name: Ontology CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  ontology-validation:
    runs-on: ubuntu-latest
    container: 
      image: stain/jena
      options: --user root

    steps:
    # Verified action references
    - name: Checkout repository
      uses: actions/checkout@v4  # Updated to v4

    - name: Set up Python
      uses: actions/setup-python@v5  # Updated to v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y python3-pip jena
        pip install robotframework rdflib

    - name: Make scripts executable
      run: |
        chmod +x scripts/merge_ontology.sh
        chmod +x scripts/validate_sparql.sh

    - name: Merge ontology
      run: |
        ./scripts/merge_ontology.sh auto-ontology automobile_merged.ttl
        ls -lh

    - name: Basic RDF validation
      run: riot --validate automobile_merged.ttl

    - name: OWL validation with ROBOT
      run: |
        robot validate --input automobile_merged.ttl \
          --output-dir ./validation-reports \
          --profile owl-el

    - name: SPARQL validation
      run: |
        ./scripts/validate_sparql.sh automobile_merged.ttl sparql/validation_queries/

    # Verified artifact upload
    - name: Upload validation artifacts
      uses: actions/upload-artifact@v4  # Updated to v4
      with:
        name: ontology-artifacts
        path: |
          automobile_merged.ttl
          validation-reports/*
          sparql_results/*
        retention-days: 5

    # Only upload docs if successful
    - name: Upload documentation
      if: success()
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs/